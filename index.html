<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SwagriTech Vineyard Maps</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f7f7f7; }
    #map { height: 100vh; width: 100%; display:none; }

    .controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      z-index: 10;
      min-width: 320px;
      user-select: none;
      display:none;
    }

    .row { margin-top: 8px; }
    .btnRow { display: flex; gap: 6px; flex-wrap: wrap; }
    button { flex: 1; padding: 8px 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
    button:hover { background: #f5f5f5; }
    select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; }

    .small { font-size: 12px; color: #555; line-height: 1.25; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .pill {
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
      font-weight: 700;
      color: #111;
    }

    .checkRow { display:flex; gap:10px; flex-wrap:wrap; }
    .checkRow label { font-size: 12px; display:flex; align-items:center; gap:6px; }

    hr { border: none; border-top: 1px solid #eee; margin: 10px 0; }

    /* Landing */
    #landing {
      display:none;
      padding: 18px;
      max-width: 820px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-top: 14px;
    }
    .warn {
      background: #fff3cd;
      border: 1px solid #ffe69c;
      border-radius: 14px;
      padding: 12px;
      margin-top: 12px;
    }
    .ok {
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
      border-radius: 14px;
      padding: 12px;
      margin-top: 12px;
      display:none;
    }
    .landingTitle {
      margin: 0 0 8px 0;
      font-size: 22px;
    }
    code { background: #f2f2f2; padding: 2px 6px; border-radius: 8px; }
  </style>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmR2Rk1b0drx0zCWI6LMjdkRP2f_Lk-0E&callback=initMap"
    async defer></script>
</head>

<body>

  <!-- Landing / Instructions -->
  <div id="landing">
    <h1 class="landingTitle">Vineyard Maps</h1>
    <div class="small">
      This tool is used to walk vineyards with zone overlays and live GPS.
    </div>

    <div id="landingError" class="warn" style="display:none;">
      <strong>We couldn’t find that vineyard.</strong><br>
      <span class="small">Path entered: <span id="badPathText" class="mono"></span></span>
    </div>

    <div class="card">
      <strong>Open your vineyard</strong>
      <p class="small" style="margin-top:8px;">
        Use the link provided by Southwest Agri-Tech, for example:
      </p>
      <ul class="small">
        <li><code>https://maps.swagritech.com.au/Menzies/</code></li>
        <li><code>https://maps.swagritech.com.au/Menzies/?block=1</code></li>
      </ul>
    </div>

    <!-- Optional upgrade: Find my vineyard -->
    <div class="card">
      <strong>Find my vineyard</strong>
      <p class="small" style="margin-top:8px;">
        If you know your vineyard/customer name, enter it below (e.g. <code>Menzies</code>) and tap Find.
      </p>
      <input id="vineyardInput" type="text" placeholder="Enter vineyard/customer name (e.g. Menzies)" />
      <div class="btnRow row">
        <button id="findBtn" type="button">Find</button>
        <button id="exampleBtn" type="button">Use example</button>
      </div>
      <div id="findOk" class="ok">
        <strong>Found!</strong> Redirecting…
      </div>
      <div id="findError" class="warn" style="display:none;">
        <strong>Not found.</strong>
        <div class="small" id="findErrorText" style="margin-top:6px;"></div>
      </div>
      <div class="small" style="margin-top:10px;">
        If you don’t have a link or name, contact Southwest Agri-Tech and we’ll send it through.
      </div>
    </div>

    <div class="small" style="margin-top:14px; color:#666;">
      © Southwest Agri-Tech
    </div>
  </div>

  <!-- Map UI -->
  <div class="controls">
    <strong>SwagriTech Vineyard Maps</strong>

    <div class="row small">
      Customer: <span id="customerLabel" class="mono">—</span><br>
      Block: <span id="blockLabel" class="mono">—</span><br>
      Status: <span id="statusLabel" class="mono">Loading…</span>
    </div>

    <div class="row">
      <label class="small"><strong>Select block</strong></label>
      <select id="blockSelect"></select>
    </div>

    <div class="row">
      <strong>Zone filters</strong>
      <div class="checkRow">
        <label><input type="checkbox" id="z1" checked> Red</label>
        <label><input type="checkbox" id="z2" checked> Orange</label>
        <label><input type="checkbox" id="z3" checked> Green</label>
      </div>
    </div>

    <hr>

    <strong>GPS Walking</strong>
    <div class="btnRow row">
      <button onclick="startGPS()">Start</button>
      <button onclick="stopGPS()">Stop</button>
      <button onclick="toggleFollow()">Follow: <span id="followLabel" class="mono">ON</span></button>
    </div>

    <div class="row small">
      GPS: <span id="gpsLabel" class="mono">OFF</span>
      &nbsp; Acc: <span id="accLabel" class="mono">—</span><br>
      You are in: <span id="zoneLabel" class="pill">—</span>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // ---------------------------
    // Performance config
    // ---------------------------
    const GPS_PROCESS_THROTTLE_MS = 300;

    // ---------------------------
    // Helpers
    // ---------------------------
    const $ = (id) => document.getElementById(id);
    const setStatus = (t) => ($("statusLabel").textContent = t);

    // ---------------------------
    // Routing: customerId
    // ---------------------------
    function getCustomerIdFromPathOrNull() {
      const trimmed = location.pathname.replace(/^\/+|\/+$/g, "");
      if (!trimmed) return null;

      const first = decodeURIComponent(trimmed.split("/")[0]);
      const reserved = ["customers", "icons", "favicon.ico", "manifest.webmanifest", "service-worker.js"];
      if (reserved.includes(first.toLowerCase())) return null;

      return first;
    }

    function getQueryParam(name) {
      return new URL(location.href).searchParams.get(name);
    }

    function setQueryParam(name, value) {
      const u = new URL(location.href);
      if (value == null) u.searchParams.delete(name);
      else u.searchParams.set(name, value);
      history.replaceState({}, "", u);
    }

    // ---------------------------
    // Paths
    // ---------------------------
    function blocksIndexUrl(customer) {
      return `/customers/${encodeURIComponent(customer)}/blocks.json`;
    }

    // boundary: block<NUM>boundary.geojson
    // rx:       block<NUM>rx.geojson
    function blockDataPaths(customer, blockId) {
      const c = encodeURIComponent(customer);
      const b = encodeURIComponent(blockId);
      return {
        boundary: `/customers/${c}/blocks/${b}/block${b}boundary.geojson`,
        rx:       `/customers/${c}/blocks/${b}/block${b}rx.geojson`
      };
    }

    // ---------------------------
    // Landing view
    // ---------------------------
    function showLanding(badPath = null) {
      $("map").style.display = "none";
      document.querySelector(".controls").style.display = "none";
      $("landing").style.display = "block";

      const errBox = $("landingError");
      const badText = $("badPathText");
      if (badPath) {
        errBox.style.display = "block";
        badText.textContent = badPath;
      } else {
        errBox.style.display = "none";
        badText.textContent = "";
      }
    }

    function showApp() {
      $("landing").style.display = "none";
      $("map").style.display = "block";
      document.querySelector(".controls").style.display = "block";
    }

    // Optional upgrade: "Find my vineyard"
    function setupLandingFindBox() {
      const input = $("vineyardInput");
      const findBtn = $("findBtn");
      const exampleBtn = $("exampleBtn");
      const okBox = $("findOk");
      const errBox = $("findError");
      const errText = $("findErrorText");

      function normalizeName(s) {
        return (s || "").trim().replace(/^\/+|\/+$/g, "");
      }

      async function tryFind() {
        const name = normalizeName(input.value);
        okBox.style.display = "none";
        errBox.style.display = "none";
        errText.textContent = "";

        if (!name) {
          errBox.style.display = "block";
          errText.textContent = "Please enter a vineyard/customer name (e.g. Menzies).";
          return;
        }

        const url = blocksIndexUrl(name);
        try {
          const r = await fetch(url, { cache: "no-store" });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          // Validate JSON
          await r.json();

          okBox.style.display = "block";
          // Redirect to /<name>/ (keeps it clean)
          setTimeout(() => {
            location.href = `/${encodeURIComponent(name)}/`;
          }, 450);
        } catch (e) {
          errBox.style.display = "block";
          errText.textContent = `We couldn't find "${name}". Make sure it's spelled exactly as provided, or contact Southwest Agri-Tech.`;
        }
      }

      findBtn.addEventListener("click", tryFind);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") tryFind();
      });

      exampleBtn.addEventListener("click", () => {
        input.value = "Menzies";
        tryFind();
      });
    }

    // ---------------------------
    // Map + data state
    // ---------------------------
    let map;
    let boundaryLayer, zonesLayer;

    let customerId = null;
    let blocksConfig = null;
    let currentBlockId = null;

    // GPS
    let gpsWatch = null;
    let gpsMarker = null;
    let gpsCircle = null;
    let followMode = true;
    let lastGpsProcessAt = 0;

    // Zone hit-test cache
    let zoneGeoms = [];   // { zone, geo }
    let highlightedZone = null;

    // ---------------------------
    // Zone helpers
    // ---------------------------
    function zoneToColor(z) {
      if (z === 1) return "#ff0000";
      if (z === 2) return "#ffa500";
      if (z === 3) return "#00ff00";
      return "#00bfff";
    }

    function zoneEnabled(z) {
      if (z === 1) return $("z1").checked;
      if (z === 2) return $("z2").checked;
      if (z === 3) return $("z3").checked;
      return true;
    }

    function zoneNameFromNumber(z) {
      if (z === 1) return "Red zone";
      if (z === 2) return "Orange zone";
      if (z === 3) return "Green zone";
      return `Zone ${z}`;
    }

    function setZonePill(zoneNum) {
      const pill = $("zoneLabel");

      if (zoneNum === 1) {
        pill.textContent = "Red zone";
        pill.style.background = "#ff0000";
        pill.style.color = "#ffffff";
      } else if (zoneNum === 2) {
        pill.textContent = "Orange zone";
        pill.style.background = "#ffa500";
        pill.style.color = "#111111";
      } else if (zoneNum === 3) {
        pill.textContent = "Green zone";
        pill.style.background = "#00ff00";
        pill.style.color = "#111111";
      } else if (zoneNum == null) {
        pill.textContent = "Outside zones";
        pill.style.background = "#eee";
        pill.style.color = "#111";
      } else {
        pill.textContent = zoneNameFromNumber(zoneNum);
        pill.style.background = "#eee";
        pill.style.color = "#111";
      }
    }

    // ---------------------------
    // GeoJSON loading (awaitable)
    // ---------------------------
    function loadGeoJsonIntoLayer(layer, url) {
      return new Promise((resolve, reject) => {
        fetch(url, { cache: "no-store" })
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
            return r.json(); // validate JSON
          })
          .then(() => {
            layer.loadGeoJson(url, null, () => resolve());
          })
          .catch(reject);
      });
    }

    function computeLayerBounds(layer) {
      const b = new google.maps.LatLngBounds();
      let any = false;
      layer.forEach(f => {
        const g = f.getGeometry();
        if (!g) return;
        g.forEachLatLng(ll => { b.extend(ll); any = true; });
      });
      return any ? b : null;
    }

    function geometryToGeoJson(g) {
      if (!g) return null;
      const t = g.getType();

      if (t === "Polygon") {
        return {
          type: "Polygon",
          coordinates: g.getArray().map(ring =>
            ring.getArray().map(p => [p.lng(), p.lat()])
          )
        };
      }

      if (t === "MultiPolygon") {
        return {
          type: "MultiPolygon",
          coordinates: g.getArray().map(poly =>
            poly.getArray().map(ring =>
              ring.getArray().map(p => [p.lng(), p.lat()])
            )
          )
        };
      }

      return null;
    }

    // ---------------------------
    // Point in polygon
    // ---------------------------
    function pointInRing(x, y, ring) {
      let inside = false;
      for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
        const xi = ring[i][0], yi = ring[i][1];
        const xj = ring[j][0], yj = ring[j][1];
        const intersect =
          ((yi > y) !== (yj > y)) &&
          (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function pointInPolygon(x, y, rings) {
      if (!rings || rings.length === 0) return false;
      if (!pointInRing(x, y, rings[0])) return false;
      for (let h = 1; h < rings.length; h++) {
        if (pointInRing(x, y, rings[h])) return false;
      }
      return true;
    }

    function pointInGeom(x, y, geom) {
      if (!geom) return false;
      if (geom.type === "Polygon") return pointInPolygon(x, y, geom.coordinates);
      if (geom.type === "MultiPolygon") return geom.coordinates.some(p => pointInPolygon(x, y, p));
      return false;
    }

    // ---------------------------
    // Styling
    // ---------------------------
    function styleZones(feature) {
      const z = Number(feature.getProperty("zone"));
      const enabled = zoneEnabled(z);
      const isHighlighted = (highlightedZone != null && z === highlightedZone);

      return {
        visible: enabled,
        fillColor: zoneToColor(z),
        fillOpacity: isHighlighted ? 0.75 : 0.55,
        strokeColor: isHighlighted ? "#1a73e8" : "#000000",
        strokeOpacity: isHighlighted ? 1.0 : 0.6,
        strokeWeight: isHighlighted ? 2.5 : 0.6
      };
    }

    function refreshZones() {
      zonesLayer.setStyle(styleZones);
    }

    // ---------------------------
    // Map init entrypoint (called by Google Maps callback)
    // ---------------------------
    async function initMap() {
      setupLandingFindBox();

      customerId = getCustomerIdFromPathOrNull();

      // If root or reserved path => show instructions page
      if (!customerId) {
        showLanding(null);
        return;
      }

      // Try to load blocks.json first. If missing => show instructions with error.
      try {
        const test = await fetch(blocksIndexUrl(customerId), { cache: "no-store" });
        if (!test.ok) throw new Error(`HTTP ${test.status}`);
        await test.json();
      } catch (e) {
        console.warn("Unknown customer:", customerId, e);
        showLanding(location.pathname);
        return;
      }

      // Customer is valid, show map UI
      showApp();

      $("customerLabel").textContent = customerId;
      $("followLabel").textContent = "ON";
      $("gpsLabel").textContent = "OFF";
      $("accLabel").textContent = "—";
      setZonePill(undefined);

      map = new google.maps.Map($("map"), {
        mapTypeId: "satellite",
        center: { lat: -33.8, lng: 115.08 },
        zoom: 17
      });

      boundaryLayer = new google.maps.Data({ map });
      zonesLayer = new google.maps.Data({ map });

      boundaryLayer.setStyle({
        strokeColor: "#00ffff",
        strokeWeight: 2,
        fillColor: "#00ffff",
        fillOpacity: 0.06
      });

      zonesLayer.setStyle(styleZones);

      // Filters: restyle, then re-check current GPS
      ["z1","z2","z3"].forEach(id => $(id).addEventListener("change", () => {
        refreshZones();
        if (gpsMarker) highlightZoneAt(gpsMarker.getPosition(), { forceUpdate: true });
      }));

      // Load blocks list
      setStatus("Loading blocks…");
      try {
        blocksConfig = await fetchJson(blocksIndexUrl(customerId));
      } catch (e) {
        console.error(e);
        setStatus("ERROR");
        showLanding(location.pathname);
        return;
      }

      populateBlocksDropdown(blocksConfig);

      const qBlock = getQueryParam("block");
      const defaultBlock = blocksConfig.defaultBlock || (blocksConfig.blocks?.[0]?.id);
      const initial = (qBlock && hasBlock(qBlock)) ? qBlock : defaultBlock;

      if (!initial) {
        setStatus("ERROR");
        alert("blocks.json contains no blocks.");
        return;
      }

      await loadBlock(initial);
    }

    async function fetchJson(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return r.json();
    }

    function hasBlock(id) {
      return (blocksConfig?.blocks || []).some(b => String(b.id) === String(id));
    }

    function populateBlocksDropdown(cfg) {
      const sel = $("blockSelect");
      sel.innerHTML = "";

      for (const b of (cfg.blocks || [])) {
        const opt = document.createElement("option");
        opt.value = String(b.id);
        opt.textContent = b.name ? b.name : `Block ${b.id}`;
        sel.appendChild(opt);
      }

      sel.addEventListener("change", async () => {
        await loadBlock(sel.value);
      });
    }

    // ---------------------------
    // Block loading
    // ---------------------------
    async function loadBlock(blockId) {
      currentBlockId = String(blockId);
      $("blockLabel").textContent = currentBlockId;
      setQueryParam("block", currentBlockId);

      const sel = $("blockSelect");
      if (sel.value !== currentBlockId) sel.value = currentBlockId;

      // Clear old features/caches
      boundaryLayer.forEach(f => boundaryLayer.remove(f));
      zonesLayer.forEach(f => zonesLayer.remove(f));
      zoneGeoms = [];
      highlightedZone = null;
      setZonePill(undefined);

      const paths = blockDataPaths(customerId, currentBlockId);
      setStatus("Loading block data…");

      try {
        await loadGeoJsonIntoLayer(boundaryLayer, paths.boundary);
        await loadGeoJsonIntoLayer(zonesLayer, paths.rx);

        const b1 = computeLayerBounds(boundaryLayer);
        const b2 = computeLayerBounds(zonesLayer);
        const bounds = b1 || b2;
        if (bounds) map.fitBounds(bounds);

        // Build hit-test cache (zone number + geometry)
        zonesLayer.forEach(f => {
          const z = Number(f.getProperty("zone"));
          const geo = geometryToGeoJson(f.getGeometry());
          zoneGeoms.push({ zone: z, geo });
        });

        refreshZones();
        if (gpsMarker) highlightZoneAt(gpsMarker.getPosition(), { forceUpdate: true });

        setStatus("OK");
      } catch (e) {
        console.error(e);
        setStatus("ERROR");
        alert(
          `Failed to load block ${currentBlockId}.\n\n` +
          `Expected:\n${paths.boundary}\n${paths.rx}\n\n` +
          `Check the file paths exist and are valid GeoJSON.`
        );
      }
    }

    // ---------------------------
    // GPS
    // ---------------------------
    function toggleFollow() {
      followMode = !followMode;
      $("followLabel").textContent = followMode ? "ON" : "OFF";
    }

    function startGPS() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }
      if (gpsWatch) return;

      $("gpsLabel").textContent = "ON";

      gpsWatch = navigator.geolocation.watchPosition(
        (pos) => {
          const now = Date.now();
          if (now - lastGpsProcessAt < GPS_PROCESS_THROTTLE_MS) return;
          lastGpsProcessAt = now;

          const ll = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          $("accLabel").textContent = `${Math.round(pos.coords.accuracy)}m`;

          // Blue dot marker
          if (!gpsMarker) {
            gpsMarker = new google.maps.Marker({
              map,
              position: ll,
              title: "You",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: "#1a73e8",
                fillOpacity: 1,
                strokeColor: "#ffffff",
                strokeOpacity: 1,
                strokeWeight: 3
              },
              zIndex: 9999
            });
          } else {
            gpsMarker.setPosition(ll);
          }

          // Accuracy circle (blue)
          if (!gpsCircle) {
            gpsCircle = new google.maps.Circle({
              map,
              center: ll,
              radius: pos.coords.accuracy,
              strokeColor: "#1a73e8",
              strokeOpacity: 0.35,
              strokeWeight: 1,
              fillColor: "#1a73e8",
              fillOpacity: 0.12
            });
          } else {
            gpsCircle.setCenter(ll);
            gpsCircle.setRadius(pos.coords.accuracy);
          }

          if (followMode) map.panTo(ll);
          highlightZoneAt(ll);
        },
        (err) => {
          console.error(err);
          $("gpsLabel").textContent = "ERROR";
          alert("GPS Error: " + err.message);
        },
        { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 }
      );
    }

    function stopGPS() {
      if (gpsWatch) navigator.geolocation.clearWatch(gpsWatch);
      gpsWatch = null;

      $("gpsLabel").textContent = "OFF";
      $("accLabel").textContent = "—";

      highlightedZone = null;
      setZonePill(undefined);
      refreshZones();

      if (gpsMarker) { gpsMarker.setMap(null); gpsMarker = null; }
      if (gpsCircle) { gpsCircle.setMap(null); gpsCircle = null; }
    }

    // Only restyle polygons when the zone actually changes (performance fix)
    function highlightZoneAt(latLng, { forceUpdate = false } = {}) {
      const x = latLng.lng();
      const y = latLng.lat();

      let foundZone = null;
      for (const z of zoneGeoms) {
        if (!zoneEnabled(z.zone)) continue;
        if (pointInGeom(x, y, z.geo)) { foundZone = z.zone; break; }
      }

      const newZone = (foundZone != null) ? foundZone : null;

      if (!forceUpdate && newZone === highlightedZone) {
        return; // no change => do nothing
      }

      highlightedZone = newZone;

      // Update pill colour/text
      if (highlightedZone == null) setZonePill(null);
      else setZonePill(highlightedZone);

      // Restyle zones only when needed
      refreshZones();
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SwagriTech Vineyard Maps</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }

    .controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      z-index: 1;
      min-width: 320px;
    }

    .row { margin-top: 8px; }
    .btnRow { display: flex; gap: 6px; }
    button { flex: 1; padding: 7px; cursor: pointer; }
    select { width: 100%; padding: 6px; }

    .small { font-size: 12px; color: #555; }
    .mono { font-family: ui-monospace, monospace; }
    .pill { padding: 2px 8px; border-radius: 999px; background: #eee; font-size: 12px; }

    .checkRow { display:flex; gap:10px; flex-wrap:wrap; }
    .checkRow label { font-size: 12px; display:flex; align-items:center; gap:6px; }
  </style>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmR2Rk1b0drx0zCWI6LMjdkRP2f_Lk-0E&callback=initMap"
    async defer></script>
</head>

<body>
  <div class="controls">
    <strong>SwagriTech Vineyard Maps</strong>

    <div class="row small">
      Customer: <span id="customerLabel" class="mono">—</span><br>
      Block: <span id="blockLabel" class="mono">—</span>
    </div>

    <div class="row">
      <label class="small"><strong>Select block</strong></label>
      <select id="blockSelect"></select>
    </div>

    <div class="row">
      <strong>Zone filters</strong>
      <div class="checkRow">
        <label><input type="checkbox" id="z1" checked> Zone 1</label>
        <label><input type="checkbox" id="z2" checked> Zone 2</label>
        <label><input type="checkbox" id="z3" checked> Zone 3</label>
      </div>
    </div>

    <hr>

    <strong>GPS Walking</strong>
    <div class="btnRow row">
      <button onclick="startGPS()">Start</button>
      <button onclick="stopGPS()">Stop</button>
    </div>

    <div class="row small">
      GPS: <span id="gpsLabel" class="mono">OFF</span>
      &nbsp; Acc: <span id="accLabel" class="mono">—</span><br>
      You are in: <span id="zoneLabel" class="pill">—</span>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const DEFAULT_CUSTOMER = "Menzies";

    function getCustomerIdFromPath() {
      const trimmed = location.pathname.replace(/^\/+|\/+$/g, "");
      if (!trimmed) return DEFAULT_CUSTOMER;
      const first = decodeURIComponent(trimmed.split("/")[0]);
      if (["customers","icons"].includes(first.toLowerCase())) return DEFAULT_CUSTOMER;
      return first;
    }

    function getQueryBlock() {
      return new URL(location.href).searchParams.get("block");
    }

    function setQueryBlock(blockId) {
      const u = new URL(location.href);
      u.searchParams.set("block", blockId);
      history.replaceState({}, "", u);
    }

    function blocksIndexUrl(customer) {
      return `/customers/${customer}/blocks.json`;
    }

    function blockDataPaths(customer, blockId) {
      return {
        boundary: `/customers/${customer}/blocks/${blockId}/block${blockId}boundary.geojson`,
        rx:       `/customers/${customer}/blocks/${blockId}/block${blockId}rx.geojson`
      };
    }

    let map, boundaryLayer, zonesLayer;
    let zoneGeoms = [];
    let gpsWatch = null;
    let gpsMarker = null;
    let gpsCircle = null;
    let currentBlock = null;

    async function initMap() {
      const customer = getCustomerIdFromPath();
      document.getElementById("customerLabel").textContent = customer;

      map = new google.maps.Map(document.getElementById("map"), {
        mapTypeId: "satellite",
        center: { lat: -33.8, lng: 115.08 },
        zoom: 17
      });

      boundaryLayer = new google.maps.Data({ map });
      zonesLayer = new google.maps.Data({ map });

      boundaryLayer.setStyle({
        strokeColor: "#00ffff",
        strokeWeight: 2,
        fillOpacity: 0.05
      });

      zonesLayer.setStyle(styleZone);

      ["z1","z2","z3"].forEach(id =>
        document.getElementById(id).addEventListener("change", refreshZones)
      );

      const cfg = await (await fetch(blocksIndexUrl(customer))).json();
      populateBlocks(cfg);

      const initial = getQueryBlock() || cfg.defaultBlock || cfg.blocks[0].id;
      await loadBlock(customer, initial);
    }

    function populateBlocks(cfg) {
      const sel = document.getElementById("blockSelect");
      sel.innerHTML = "";
      cfg.blocks.forEach(b => {
        const o = document.createElement("option");
        o.value = b.id;
        o.textContent = b.name || b.id;
        sel.appendChild(o);
      });
      sel.onchange = () => loadBlock(getCustomerIdFromPath(), sel.value);
    }

    async function loadBlock(customer, blockId) {
      currentBlock = blockId;
      document.getElementById("blockLabel").textContent = blockId;
      setQueryBlock(blockId);

      boundaryLayer.forEach(f => boundaryLayer.remove(f));
      zonesLayer.forEach(f => zonesLayer.remove(f));
      zoneGeoms = [];

      const paths = blockDataPaths(customer, blockId);

      await boundaryLayer.loadGeoJson(paths.boundary);
      await zonesLayer.loadGeoJson(paths.rx);

      const bounds = new google.maps.LatLngBounds();
      boundaryLayer.forEach(f => f.getGeometry().forEachLatLng(ll => bounds.extend(ll)));
      map.fitBounds(bounds);

      zonesLayer.forEach(f => {
        const z = Number(f.getProperty("zone"));
        const r = f.getProperty("rate");
        const u = f.getProperty("unit");
        const g = geometryToGeoJson(f.getGeometry());
        zoneGeoms.push({ zone:z, rate:r, unit:u, geo:g });
      });
    }

    function styleZone(f) {
      const z = Number(f.getProperty("zone"));
      const enabled =
        (z===1 && z1.checked) ||
        (z===2 && z2.checked) ||
        (z===3 && z3.checked);
      return {
        visible: enabled,
        fillColor: z===1?"#f00":z===2?"#ffa500":"#0f0",
        fillOpacity: 0.55,
        strokeWeight: 0.6
      };
    }

    function refreshZones() {
      zonesLayer.setStyle(styleZone);
    }

    function geometryToGeoJson(g) {
      if (!g) return null;
      if (g.getType()==="Polygon") {
        return { type:"Polygon", coordinates: g.getArray().map(r=>r.getArray().map(p=>[p.lng(),p.lat()])) };
      }
      if (g.getType()==="MultiPolygon") {
        return { type:"MultiPolygon", coordinates: g.getArray().map(p=>p.getArray().map(r=>r.getArray().map(pt=>[pt.lng(),pt.lat()]))) };
      }
    }

    function startGPS() {
      if (gpsWatch) return;
      gpsWatch = navigator.geolocation.watchPosition(pos=>{
        const ll = {lat:pos.coords.latitude,lng:pos.coords.longitude};
        accLabel.textContent = Math.round(pos.coords.accuracy)+"m";
        gpsLabel.textContent = "ON";

        if (!gpsMarker) gpsMarker = new google.maps.Marker({ map, position: ll });
        else gpsMarker.setPosition(ll);

        if (!gpsCircle) gpsCircle = new google.maps.Circle({ map, center: ll, radius: pos.coords.accuracy });
        else { gpsCircle.setCenter(ll); gpsCircle.setRadius(pos.coords.accuracy); }

        highlightZone(ll);
      });
    }

    function stopGPS() {
      if (gpsWatch) navigator.geolocation.clearWatch(gpsWatch);
      gpsWatch=null;
      gpsLabel.textContent="OFF";
      accLabel.textContent="—";
      zoneLabel.textContent="—";
      if (gpsMarker) gpsMarker.setMap(null), gpsMarker=null;
      if (gpsCircle) gpsCircle.setMap(null), gpsCircle=null;
    }

    function highlightZone(pt) {
      for (const z of zoneGeoms) {
        if (pointInGeom(pt.lng, pt.lat, z.geo)) {
          zoneLabel.textContent = `Zone ${z.zone} • ${z.rate} ${z.unit||""}`;
          return;
        }
      }
      zoneLabel.textContent = "Outside zones";
    }

    function pointInGeom(x,y,g) {
      if (!g) return false;
      if (g.type==="Polygon") return pip(x,y,g.coordinates);
      if (g.type==="MultiPolygon") return g.coordinates.some(p=>pip(x,y,p));
    }

    function pip(x,y,rings) {
      let inside=false;
      const r=rings[0];
      for(let i=0,j=r.length-1;i<r.length;j=i++){
        const xi=r[i][0], yi=r[i][1], xj=r[j][0], yj=r[j][1];
        const hit=((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi);
        if(hit) inside=!inside;
      }
      return inside;
    }
  </script>
</body>
</html>
